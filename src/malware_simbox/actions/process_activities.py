import os
import shutil
import platform
import subprocess
import time
from malware_simbox.handler.log_handler import log_errors
from malware_simbox.actions.action import Action

class ProcessActivity(Action):

    def __init__(self) -> None:
        super().__init__()


    def run(self) -> None:
        self._monitor_process()
        self._create_and_run_script()
        self._install_and_uninstall_program()


    @log_errors
    def _monitor_process(self) -> None:
        """Starts and terminates a simple Windows process (Notepad) to simulate monitoring."""

        if platform.system().lower() == "windows":
            # Launch Notepad
            p = subprocess.Popen(["notepad.exe"])

            time.sleep(2)
            p.terminate()


    @log_errors
    def _create_and_run_script(self) -> None:
        """Creates and executes a simple PowerShell script on Windows."""

        if platform.system().lower() == "windows":
            ps1 = "Write-Output 'Hello from Malware test script'; Start-Sleep -Seconds 1"

            # Write script to file
            with open("test.ps1", "w") as f:
                f.write(ps1)
            
            # Execute the script with bypassed execution policy
            subprocess.run([
                "powershell.exe", 
                "-ExecutionPolicy", "Bypass", 
                "-File", "test.ps1"
            ], check=True)


    @log_errors
    def _install_and_uninstall_program(self) -> None:
        """Simulates installation and uninstallation of a test program."""

        if platform.system().lower() == "windows":
            # Get Program Files directory
            pf = os.environ.get("ProgramFiles", "C:\\Program Files")

            # Create test installation folder
            install_dir = os.path.join(pf, "Malware_TestApp")
            os.makedirs(install_dir, exist_ok=True)

            # Copy test script to the directory
            shutil.copy("test.ps1", install_dir)

            # Remove the directory to simulate uninstallation
            shutil.rmtree(install_dir)
