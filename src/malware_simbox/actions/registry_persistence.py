import sys
import winreg as reg
import platform
from malware_simbox.handler.log_handler import log_errors
from malware_simbox.actions.action import Action

class RegistryInjection(Action):

    def __init__(self) -> None:
        super().__init__()


    def run(self) -> None:
        if platform.system().lower() == "windows":

            self._set_registry_key()
            self._create_registry_key()


    @log_errors
    def _set_registry_key(self) -> None:
        """Sets a registry value under a specified key and path."""

        registry_path = "Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        value = "MalwareSimulation"

        # Open the registry key with write access
        reg_key = reg.OpenKey(reg.HKEY_CURRENT_USER, registry_path, 0, reg.KEY_WRITE)

        # Set the specified value to the current script path
        reg.SetValueEx(reg_key, value, 0, reg.REG_SZ, sys.argv[0])
        reg.CloseKey(reg_key)


    @log_errors
    def _create_registry_key(self) -> None:
        """Creates and deletes a test registry key and value."""

        # Create the subkey
        sub_key = "Software\\MalwareSimulation"
        reg_key = reg.CreateKey(reg.HKEY_CURRENT_USER, sub_key)

        # Set a test value within the key
        reg.SetValueEx(reg_key, "TestValue", 0, reg.REG_SZ, "Malware")
        reg.CloseKey(reg_key)

        # Delete the created key to clean up
        reg.DeleteKey(reg.HKEY_CURRENT_USER, sub_key)
