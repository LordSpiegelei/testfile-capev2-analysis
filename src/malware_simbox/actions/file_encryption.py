import os 
import platform
from malware_simbox.handler.log_handler import log_errors
from cryptography.fernet import Fernet

from malware_simbox.actions.action import Action

class FileEncryption(Action):

    def __init__(self) -> None:
        super().__init__()

        if platform.system().lower() == "windows":
            self.system_file_path = os.path.join( os.getenv("WINDIR"), "System32")
        else:
            raise NotImplementedError()


    def run(self) -> None:
        self._encrypt()


    @log_errors
    def _encrypt(self):
        """Encrypts a fake test file"""

        # Generate a key for encryption
        key = Fernet.generate_key()
        cipher = Fernet(key)
        
        # Create a fake file to "encrypt"
        file_path = os.path.join(self.system_file_path, "important_file.txt")
        content = b"This is a test file to simulate encryption."

        self.write_file(file_path, content)

        # Simulate file encryption
        encrypted_data = cipher.encrypt(content)

        # Overwrite the file with "encrypted" data
        self.write_file(file_path, encrypted_data)
